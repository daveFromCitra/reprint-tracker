<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citra Large Format Reprints</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.3/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous">
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js"
        integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI=" crossorigin="anonymous"></script>
    <script src="./script.js" defer></script>
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-light">
        <div class="container">
            <a class="navbar-brand" href="#">DPG Reprint Tracker</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link disabled" id="login-btn">Login</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="logout-btn">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <section id="logged-out" class="py-4">
        <div class="container-sm">
            <h1>You there? Identify yourself!</h1>
            <img src="https://m.media-amazon.com/images/I/61DpzbmqsWL._AC_SX679_.jpg" alt="I am McLovin">
        </div>
    </section>
    <section id="logged-in" style="display: none;">
        <div class="container-sm" id="main-card-area">
            <div class="py-4">
                <h1>Large Format Reprint Queue</h1>
                <h4 id="alt-subtitle">(Aim away from face)</h4>
                <hr>
                <!-- Button trigger modal -->
                <button type="button" class="btn btn-success btn-lg" data-bs-toggle="modal"
                    data-bs-target="#exampleModal">
                    Request a Reprint
                </button>
            </div>
            <!-- Modal -->
            <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Reprint Request</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3" id="reprint-form">
                                <label class="form-label" for="">User Name</label>
                                <input class="form-control" type="text" id="user-name">
                                <br>
                                <div class="row">
                                    <div class="col">
                                        <label class="form-label" for="">Order Number</label>
                                        <input class="form-control" type="text" id="order-number">
                                    </div>
                                    <div class="col">
                                        <label class="form-label" for="">Sku</label>
                                        <input class="form-control" type="text" id="item-number">
                                    </div>
                                </div>
                                <br>
                                <div class="row">
                                    <div class="col">
                                        <label class="form-label" for="">Quantity Needed</label>
                                        <input class="form-control" type="text" id="item-quantity-needed">
                                    </div>
                                    <div class="col">
                                        <label class="form-label" for="">Quantity Total</label>
                                        <input class="form-control" type="text" id="item-quantity-total">
                                    </div>
                                </div>
                                <br>
                                <label class="form-label" for="">Size</label>
                                <input class="form-control" type="text" id="item-size">
                                <br>

                                <label class="form-label" for="">Reason</label>
                                <input class="form-control" type="text" id="reason" list="reasonOptions">
                                <datalist id="reasonOptions">
                                    <option value="Laminate issue">
                                    <option value="Missing quantity">
                                    <option value="Print issue">
                                    <option value="Cut issue">
                                </datalist>
                            </div>
                            <div id="form-alert-zone">

                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button class="btn btn-primary" id="main-check">Submit</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <div class="container-sm" id="reprint-stack">
            <h2>Reprint Stack</h2>
            <div id="filter-boxes" class="my-2">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="requestedCheckbox" value="requested" checked>
                    <label class="form-check-label" for="inlineCheckbox1">Requested</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="pulledCheckbox" value="pulled" checked>
                    <label class="form-check-label" for="inlineCheckbox2">Pulled</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="printedCheckbox" value="printed" checked>
                    <label class="form-check-label" for="inlineCheckbox2">Printed</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="completeCheckbox" value="complete">
                    <label class="form-check-label" for="inlineCheckbox2">Complete</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="deletedCheckbox" value="deleted">
                    <label class="form-check-label" for="inlineCheckbox2">Delete</label>
                </div>
            </div>
            <div class="input-group">
                <button class="btn btn-success" id="main-update">Update</button>
                <select id="updateCommand" class="form-select" aria-label="Default select example">
                    <option selected>Select status for update...</option>
                    <option value="requested">Requested</option>
                    <option value="pulled">Pulled</option>
                    <option value="printed">Printed</option>
                    <option value="complete">Complete</option>
                    <option value="deleted">Delete</option>
                </select>
                <button id="refresh-button" class="btn">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <table id="reprint-stack-list" class="table">

            </table>
        </div>
    </section>
    <nav class="navbar fixed-bottom navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand">DPG/Citra/LargeFormat Storefront - 2022</a>
        </div>
    </nav>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, getDoc, setDoc, doc, arrayUnion, updateDoc } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-auth.js";
      
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCjy8BWbKT_X5CXiemBrDsY21gd59aN5EI",
          authDomain: "citralargeformatreprints.firebaseapp.com",
          projectId: "citralargeformatreprints",
          storageBucket: "citralargeformatreprints.appspot.com",
          messagingSenderId: "674108428983",
          appId: "1:674108428983:web:ffb133bef2454d7caf7332"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
          // Init Database
        const db = getFirestore();
        // Init Auth
        const auth = getAuth();
        const provider = new GoogleAuthProvider();

        function logIn() {
            signInWithPopup(auth, provider)
            .then((result) => {
                // This gives you a Google Access Token. You can use it to access the Google API.
                const credential = GoogleAuthProvider.credentialFromResult(result);
                const token = credential.accessToken;
                // The signed-in user info.
                const user = result.user;
                // ...
            }).catch((error) => {
                // Handle Errors here.
                const errorCode = error.code;
                const errorMessage = error.message;
                // The email of the user's account used.
                const email = error.customData.email;
                // The AuthCredential type that was used.
                const credential = GoogleAuthProvider.credentialFromError(error);
                // ...
            });
        }

        function logOut() {
            auth.signOut()
        }

        auth.onAuthStateChanged(user => {
            const loggedIn = document.getElementById("logged-in");
            const loggedOut = document.getElementById("logged-out");
            const logInBtn = document.getElementById("login-btn");
            const logOutBtn = document.getElementById("logout-btn"); 

            if (user) {
                console.log(user);
                loggedOut.style.display = 'none'
                loggedIn.style.display = 'block'
                logInBtn.classList.add("disabled")
                logOutBtn.classList.remove("disabled")

                reprintStackUpdate();

            } else {
                loggedOut.style.display = 'block'
                loggedIn.style.display = 'none'
                logInBtn.classList.remove("disabled")
                logOutBtn.classList.add("disabled")
            }
        }) 

        // Button Event Listeners
        // Check
        document.getElementById("main-check").addEventListener("click", function(e) {
            e.preventDefault();
            checkPrint();
        })
        // Command Update
        document.getElementById("main-update").addEventListener("click", function(e) {
            e.preventDefault();
            updateItem();
        })
        // Table Refresh
        document.getElementById("refresh-button").addEventListener("click", function(e) {
            e.preventDefault();
            reprintStackUpdate();
        })
        // Change filters selected
        document.getElementById("filter-boxes").addEventListener("change", function(e) {
            e.preventDefault();
            reprintStackUpdate();
        })
        // Log In Button
        document.getElementById("login-btn").addEventListener("click", function(e) {
            e.preventDefault();
            logIn();
        })
        // Log Out Button
        document.getElementById("logout-btn").addEventListener("click", function(e) {
            e.preventDefault();
            logOut();
        })

        // Check if the reprint has already been requested
        function checkPrint() {
            const alertZone = document.getElementById("form-alert-zone")
            const alert = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <strong>Woah now!</strong> Looks like that one has already been marked for reprint. Sure you wanna reprint that
                                partner?<br>
                                <button id="check-submit" class="btn btn-danger mt-3" data-bs-dismiss="alert">I'm sure</button>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"
                                    aria-label="Close"></button>
                            </div>`
            

            
            let orderId = document.getElementById("order-number").value;
            let itemId = document.getElementById("item-number").value;

            let q = query(collection(db, "reprints"), where("orderId", "==", orderId), where("itemId", "==", itemId));
            getDocs(q)
            .then((docs) => {
                if (docs.docs.length > 0) {
                    alertZone.innerHTML = alert;
                    document.getElementById("check-submit").addEventListener("click", function(e) {
                        e.preventDefault();
                        submitReprint();
                    })
                } else {
                    submitReprint()
                }
                //docs.docs.map( console.log(this._document.data.value.mapValue) );
                docs.docs.map( (item) => { console.log(item.data()) });

            })
            .catch((error) => {
                console.error(error);
            })
        }

        // Update the status of a line item
        function updateItem() {
            const updateCommand = document.getElementById("updateCommand").value
            const itemList = document.getElementById("reprint-stack-list")
            const itemArray = itemList.querySelectorAll(".reprint-item")
            itemArray.forEach(item => {
                let refId = item.dataset.refId
                let refIdDoc = doc(db, 'reprints', refId);
                let isChecked = item.children[0].children[0].checked
                if (isChecked) {
                    setDoc(refIdDoc, { status: updateCommand }, { merge: true })
                    .then(() => {
                        logUpdate(refId, updateCommand);
                        reprintStackUpdate();
                    })
                } else {}
            });
            
        }

        // Log any update to the line item status
        function logUpdate(refId, action) {
            let logEntry = {"action": action, "time": Date.now()}
            getDoc(doc(db, "reprints", refId))
            .then((docLog) => {
                let updateLog = docLog.data().updated
                updateLog.push(logEntry);
                setDoc(doc(db, 'reprints', refId), { updated: updateLog }, { merge: true })
            })
            
            // pull the update log
            
        }

        // The reprint has been added to the queue 
        function submitReprint() {
            let username = document.getElementById("user-name").value;
            let orderId = document.getElementById("order-number").value;
            let itemId = document.getElementById("item-number").value;
            let reason = document.getElementById("reason").value;
            let qtyNeeded = document.getElementById("item-quantity-needed").value;
            let qtyTotal = document.getElementById("item-quantity-total").value;
            let size = document.getElementById("item-size").value;
            let timestamp = Date.now();

            addDoc(collection(db, "reprints"), {
                    name: username,
                    orderId: orderId,
                    itemId: itemId,
                    reason: reason,
                    size: size,
                    created: timestamp,
                    status: "requested",
                    qtyNeeded: qtyNeeded,
                    qtytotal: qtyTotal,
                    updated: []
                }).then(() => {
                    reprintStackUpdate();
                    $("#exampleModal").modal("hide");
                    document.getElementById("user-name").value = '';
                    document.getElementById("order-number").value = '';
                    document.getElementById("item-number").value = '';
                    document.getElementById("reason").value = '';
                    document.getElementById("item-quantity-needed").value = '';
                    document.getElementById("item-quantity-total").value = '';
                    document.getElementById("item-size").value = '';
                }
                )
                .catch((error) => {
                    console.error(error);
                })
        }

        // Checks the status filters, to see what the user wants to view
        function statusCheckboxes() {
            let checkedBoxes = [];
            document.getElementById("requestedCheckbox").checked && (checkedBoxes.push("requested"))
            document.getElementById("pulledCheckbox").checked && (checkedBoxes.push("pulled"))
            document.getElementById("printedCheckbox").checked && (checkedBoxes.push("printed"))
            document.getElementById("completeCheckbox").checked && (checkedBoxes.push("complete"))
            document.getElementById("deletedCheckbox").checked && (checkedBoxes.push("deleted"))
            return checkedBoxes
        }

        // Updates the reprint list
        function reprintStackUpdate() {
            // Identifies the stack list container
            const stackListContainer = document.getElementById("reprint-stack-list");
            // Generates the header row for the stacklist
            let currentStack = '<tr><th>#</th><th>Order</th><th>Sku</th><th>Submitter Name</th><th>Reason</th><th>Status</th></tr>';
            // Queries the database for the checked areas
            let multi = query(collection(db, "reprints"), where("status", "in", statusCheckboxes()))
            // Pulls the items based on the query
            getDocs(multi)
            .then((docs) => {
                // generates a line per item in the stack as html
                docs.forEach(reprint => {
                    try {
                        let reprintData = reprint.data()
                        let itemId = reprintData.itemId;
                        let name = reprintData.name;
                        let orderId = reprintData.orderId;
                        let reason = reprintData.reason;
                        let status = reprintData.status;
                        let refId = reprint.id
                        let rowStyle = 'secondary';
                        switch (status) {
                            case 'complete':
                                rowStyle = 'success'
                                break;
                            case 'requested':
                                rowStyle = 'warning'
                                break;
                            case 'pulled':
                                rowStyle = 'info'
                                break;
                            case 'printed':
                                rowStyle = 'primary'
                                break;
                            case 'deleted':
                                rowStyle = 'danger'
                                break;
                        }
                        let listItem = `<tr data-ref-id="${refId}" data-item-status=${status} class="reprint-item table-${rowStyle}"><td><input class="form-check-input" type="checkbox" value="" ></td><td>${orderId}</td><td>${itemId}</td><td>${name}</td><td>${reason}</td><td>${status}</td></tr>`
                        currentStack = currentStack + listItem;
                    } catch (error) {
                        console.error(error);
                    }
                }); 
                // places the new items in the DOM
                stackListContainer.innerHTML = currentStack;
            })
        }

      </script>
</body>

</html>